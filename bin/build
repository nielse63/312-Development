#!/usr/bin/env bash
set -e

# set default env vars
if [ ! "$NODE_ENV" ]; then
  export NODE_ENV=production
fi

# print environment information
. bin/print-env

# run locally
if [ -f node_modules/.bin/eslint ] && [ -f node_modules/.bin/stylelint ]; then
  rm -rf dist
  yarn run lint:js
  yarn run lint:scss
fi

# build for production
node --harmony --gc_interval=100 build/build.js

# move seo-related files
for file in {robots.txt,sitemap.xml}; do
  from="dist/static/$file"
  to="dist/$file"
  [ -f "$from" ] && mv "$from" "$to";
done;

# alter output html
node build/add-async.js
