#!/usr/bin/env bash
set -e

# source env vars, if available
if [ -f ".env" ]; then source .env; fi

# vars
# DATE=$(date -u +"%Y-%m-%dT%H:%M:%S")
branch=$(git branch | sed -n -e 's/^\* \(.*\)/\1/p')
# echo $branch
if [ "$branch" != "master" ]; then
  echo "! only deploy from master"
  exit 1
fi

if ! [ $HEROKU_REPO ]; then
  echo "Environment variable $HEROKU_REPO must be defined"
  exit 1
fi

git remote add heroku $HEROKU_REPO

yarn build
git remote -v

# install static buildpack
if [ $TRAVIS ]; then
  git clone https://github.com/hone/heroku-cli-static.git
  cd heroku-cli-static
  npm i
  heroku plugins:link .
  cd ..
fi

# heroku config:set API_HOST="$API_HOST"
heroku static:deploy

# cleanup
git remote remove heroku
